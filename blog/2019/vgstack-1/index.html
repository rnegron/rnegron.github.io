<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-118286402-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-118286402-1');
  </script>

      <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />

    <title>Raúl Negrón's Website</title>

    <meta charset="utf-8" />
    <link href="https://raulnegron.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Raúl Negrón's Website Full Atom Feed" />

    <link rel="canonical" href="https://raulnegron.me/blog/2019/vgstack-1"/>

    <link rel="stylesheet" href="https://raulnegron.me/theme/css/poole.css"/>
    <link rel="stylesheet" href="https://raulnegron.me/theme/css/syntax.css"/>
    <link rel="stylesheet" href="https://raulnegron.me/theme/css/lanyon.css"/>
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Oswald">
    <link rel="stylesheet" href="https://raulnegron.me/theme/css/styles.css"/>



    <meta name="tags" contents="web" />
    <meta name="tags" contents="programming" />
    <meta name="tags" contents="python" />
    <meta name="tags" contents="django" />
    <meta name="tags" contents="docker" />

  </head>

  <body>
<!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">
<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <div class="profile">
      <img src="https://raulnegron.me/theme/img/profile.png"/>
    </div>
  </div>

  <nav class="sidebar-nav">
  <a class="sidebar-nav-item" href="https://raulnegron.me/">main page</a>
      <a class="sidebar-nav-item" href="https://raulnegron.me/about">about&nbsp;me</a>
      <a class="sidebar-nav-item" href="https://raulnegron.me/reading">reading&nbsp;list</a>

      <a class="sidebar-nav-item" href="https://raulnegron.me/blog.html">blog</a>


  <a class="sidebar-nav-item" href="https://github.com/rnegron" target="_blank">github</a>
  <a class="sidebar-nav-item" href="https://www.linkedin.com/in/raulnegron/" target="_blank">linkedin</a>
  </nav>

  <div class="sidebar-item">
    <p>Site written in <a href="https://daringfireball.net/projects/markdown/">Markdown</a>, generated by <a href="http://docs.getpelican.com/en/stable/">Pelican</a>, hosted on <a href="https://pages.github.com/">Github Pages</a> and registered using <a href="https://aws.amazon.com/route53/">Route 53</a>.</p>
    <p class="tiny-note">
      <a class="muted" href="https://github.com/thomaswilley/pelicanyan">theme: modified pelicanyan v0.1</a>
    </p>
  </div>
</div>    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="https://raulnegron.me/" title="Home">Raúl Negrón's Website</a>
          </h3>
        </div>
      </div>

      <div class="container content">
<div class="posts">
<div class="post">
    <h1 class="post-title">
      Full-Stack Project: vg-stack (Part&nbsp;1)
    </h1>
    <span class="post-date">January 19, 2019</span>

    <h1>Motivation</h1>
<p>In the web development space, tools and best-practices change quite frequently. At one point in the not-so-distant past, a <a href="https://en.wikipedia.org/wiki/LAMP_%28software_bundle%29"><span class="caps">LAMP</span></a> stack was the go-to approach for launching a web application. These days, <span class="caps">PHP</span> is the #8 most popular programming language (according to a company with the name <a href="https://www.tiobe.com/tiobe-index/">&#8220;The Importance Of Being Earnest&#8221;</a>), while Python and JavaScript rank above&nbsp;it.</p>
<p>One of the reason for this change has to do with the growing trend towards microservice architectures. Together with the need for rapid prototyping and the onset of agile development methodologies, Python and other languages have swept in and stolen the <span class="caps">LAMP</span> stack&#8217;s&nbsp;lunch.</p>
<p>So what is the <em>new stack</em>? A complex question with opinionated answers&#8230; Here is a recent community discussion on Hacker News: <a href="https://news.ycombinator.com/item?id=18829557">Go-to web stack&nbsp;today?</a></p>
<p>But wow, there are so many things to learn and keep up to date with nowadays! To help alleviate this, I&#8217;d like to work on a side-project using full-stack technologies. In particular, I want to use the following tools to build a fullstack&nbsp;app:</p>
<ul>
<li>Django&nbsp;(backend)</li>
<li>Angular&nbsp;(frontend)</li>
<li>Docker&nbsp;(development/deployment)</li>
<li>Postgres&nbsp;(database)</li>
<li>&#8230; plus many more! (think git, pipenv, serverless, test-driven development&#8230; Maybe type-hints, GraphQL and data visualization&nbsp;too?)</li>
</ul>
<h1>The idea: A web app for keeping track of your video game&nbsp;backlog</h1>
<p>No shame: the project is most definitely a copy of <a href="https://backloggery.com">The Backloggery</a>, a great site that I use often. However, as far as I know, The Backloggery is <a href="https://backloggery.com/about.php">built in <span class="caps">PHP</span></a>, probably on a <span class="caps">LAMP</span> stack or similar. So I thought I would take a crack at building a small subset of the Backloggery features, on a more modern&nbsp;stack.</p>
<p>I like this idea because it comes with a well-defined problem set. I can already envision the database schema and how to build the backend. But as I mentioned, this project is going to involve the entire stack. That means I gotta learn some front-end JavaScript. In this series of blog posts, I document my&nbsp;experience.</p>
<blockquote>
<p>I should say, the reason I picked <a href="https://angular.io/">Angular</a> and not (the elephant in the room) <a href="https://reactjs.org/">React</a> is that in my <a href="https://www.abartyshealth.com">day job</a>, our frontend team works with Angular and so this is a skill I would like to improve! Besides, we all know <a href="https://en.wikipedia.org/wiki/PostgreSQL">Postgres</a> is the real elephant here, right? Let&#8217;s move&nbsp;on.</p>
</blockquote>
<h1>The app:&nbsp;vg-stack</h1>
<p>I had to name my repo&nbsp;something!</p>
<p>In all honestly, I like the name because it hints at the purpose of the project (practicing the web stack) while at the same conjuring a mental image of a bunch of video games stacked on top of each&nbsp;other.</p>
<h2>Setting&nbsp;up</h2>
<p>For this first part, I&#8217;m going to build a back-end skeleton using Django and the awesome <a href="https://www.django-rest-framework.org/">Django <span class="caps">REST</span> framework</a> package. As already mentioned, our database will be the ever-popular PostgreSQL and we are aiming for best practices in all parts of the stack. That includes deployment/development tools and environments! That said, I&#8217;m going to assume knowledge of the tools used and explain only the&nbsp;highlights.</p>
<h2>Project&nbsp;Structure</h2>
<p>In fact, I&#8217;m going to skip most of the project setup entirely and just go with a pre-built template! I like William Vincent&#8217;s <a href="https://github.com/wsvincent/drfx">drfx</a>, so let&#8217;s go ahead and clone&nbsp;that:</p>
<div class="highlight"><pre><span></span>$ git clone https://github.com/wsvincent/drfx vgstack
</pre></div>


<p>The template provided comes with a lot of best practices built in. We can build on top of it and get going&nbsp;quickly!</p>
<h3>Dependencies</h3>
<p>We&#8217;re going to install the following extra packages for now:
<a href="https://github.com/theskumar/python-dotenv">python-dotenv</a> to comply with <a href="https://12factor.net/config">mandate <span class="caps">III</span></a> of The Twelve-Factor App, <a href="https://github.com/psycopg/psycopg2">psycopg2-binary</a> to use PostgreSQL as our database, <a href="https://github.com/ambv/black">black</a> to format our code and <a href="https://github.com/FactoryBoy/factory_boy">factory_boy</a> to improve our tests&nbsp;maintenance.</p>
<div class="highlight"><pre><span></span>$ pipenv install python-dotenv psycopg2-binary
</pre></div>


<div class="highlight"><pre><span></span>$ pipenv install --pre --dev black factory_boy
</pre></div>


<p>We install <code>black</code> and <code>factory_boy</code> as development dependencies and tell Pipenv to allow the pre-release <code>black</code> package&nbsp;through!</p>
<h2>Django&nbsp;Settings</h2>
<p>Let&#8217;s get started setting up our&nbsp;project.</p>
<p>First, create a <code>.env</code> file for use with <code>python-dotenv</code>.</p>
<div class="highlight"><pre><span></span># vgstack/.env

DEBUG=on
SECRET_KEY=your-secret-key
DATABASE_USER=postgres
DATABASE_PASSWORD=postgres
DATABASE_NAME=postgres
DATABASE_HOST=database
DATABASE_PORT=5432
</pre></div>


<p>Replace the <code>SECRET_KEY</code> with an actual secret key! You can generate one in&nbsp;Python:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.core.management.utils</span> <span class="kn">import</span> <span class="n">get_random_secret_key</span>

<span class="n">get_random_secret_key</span><span class="p">()</span>
</pre></div>


<p>The database env variables can stay as they are, since those settings happily coincide with the default database, user and password in the <a href="https://hub.docker.com/_/postgres">Postgres Docker Image</a>!</p>
<p>Now, replace &#8220;drfx&#8221; with &#8220;vgstack&#8221; everywhere it appears in the project, such as in values for <code>ROOT_URLCONF</code>, <code>WSGI_APPLICATION</code> and even the main &#8220;drfx&#8221;&nbsp;directory!</p>
<p>We also modify our settings file in order to use <code>python-dotenv</code>. In the end, it should look like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="c1"># vgstack/vgstack/settings.py</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>


<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
<span class="n">dotenv_path</span> <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s1">&#39;.env&#39;</span>
<span class="n">load_dotenv</span><span class="p">(</span><span class="n">dotenv_path</span><span class="o">=</span><span class="n">dotenv_path</span><span class="p">)</span>


<span class="c1"># SECURITY WARNING: don&#39;t run with debug turned on in production!</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">)</span>

<span class="c1"># SECURITY WARNING: keep the secret key used in production secret!</span>
<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SECRET_KEY&quot;</span><span class="p">)</span>

<span class="c1"># Allow communicaiton from our Docker container if DEBUG=True</span>
<span class="n">ALLOWED_HOSTS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">DEBUG</span> <span class="k">else</span> <span class="p">[]</span>

<span class="c1"># ...</span>

<span class="n">ROOT_URLCONF</span> <span class="o">=</span> <span class="s2">&quot;vgstack.urls&quot;</span>

<span class="c1"># ...</span>

<span class="n">WSGI_APPLICATION</span> <span class="o">=</span> <span class="s2">&quot;vgstack.wsgi.application&quot;</span>

<span class="c1"># Database</span>
<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;ENGINE&quot;</span><span class="p">:</span> <span class="s2">&quot;django.db.backends.postgresql&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NAME&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATABASE_NAME&quot;</span><span class="p">),</span>
    <span class="s2">&quot;USER&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATABASE_USER&quot;</span><span class="p">),</span>
    <span class="s2">&quot;PASSWORD&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATABASE_PASSWORD&quot;</span><span class="p">),</span>
    <span class="s2">&quot;HOST&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATABASE_HOST&quot;</span><span class="p">),</span>
    <span class="s2">&quot;PORT&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATABASE_PORT&quot;</span><span class="p">),</span>
    <span class="s2">&quot;CONN_MAX_AGE&quot;</span><span class="p">:</span> <span class="mi">7200</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># ...</span>
</pre></div>


<p>Notice I replaced the <code>os.path</code> call for the new kid on the block: <code>Pathlib</code>. I&#8217;m trying to make that a&nbsp;habit!</p>
<h3>Docker</h3>
<p>Let&#8217;s build a simple Python&nbsp;Dockerfile!</p>
<div class="highlight"><pre><span></span><span class="c"># vgstack/Dockerfile</span>

<span class="c"># pull the Python official base image, slimmed down</span>
<span class="k">FROM</span><span class="s"> python:3.7-slim</span>

<span class="c"># set environment varibles</span>
<span class="k">ENV</span> PYTHONDONTWRITEBYTECODE <span class="m">1</span>
<span class="k">ENV</span> PYTHONUNBUFFERED <span class="m">1</span>

<span class="c"># set work directory</span>
<span class="k">WORKDIR</span><span class="s"> /usr/src/app</span>

<span class="c"># install dependencies with Pipenv</span>
<span class="k">RUN</span> pip install --upgrade pip <span class="o">&amp;&amp;</span> pip install pipenv
<span class="k">COPY</span> ./Pipfile /usr/src/app/Pipfile
<span class="k">RUN</span> pipenv install --system --skip-lock

<span class="c"># copy project over to image</span>
<span class="k">COPY</span> . /usr/src/app/

<span class="c"># specify our entrypoint</span>
<span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&quot;./docker-entrypoint.sh&quot;</span><span class="p">]</span>
</pre></div>


<p>And a nice docker-compose file to help us run the project and related&nbsp;services.</p>
<div class="highlight"><pre><span></span><span class="c"># vgstack/docker-compose.yml</span>

version: <span class="s1">&#39;3.7&#39;</span>

services:
  database:
    image: postgres:11-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data/

  web:
    build: .
    entrypoint: /usr/src/app/docker-entrypoint.sh
    volumes:
      - ./:/usr/src/app/
    ports:
      - <span class="m">8000</span>:8000
    env_file: .env
    depends_on:
      - database
volumes:
  postgres_data:
    external: false
</pre></div>


<p>We can see that we are persisting the Postgres database via Docker volumes. Also, we are taking advantage of the <code>env_file</code> command to load in our previously created file. Finally, we call the <code>entrypoint</code> command to run a shell script instead of running an in-line&nbsp;command.</p>
<p>The following entrypoint script is a modified version of the one found in José Padilla&#8217;s <a href="https://github.com/jpadilla/notaso">notaso</a> project. It attempts to use a PostgreSQL cursor every second, and keeps trying until a connection succeeds. Then, it proceeds to migrate the Django models and runs the development&nbsp;server.</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="c1"># vgstack/docker-entrypoint.sh</span>

<span class="nb">set</span> -e

postgres_ready<span class="o">(){</span>
python manage.py shell <span class="s">&lt;&lt; END</span>
<span class="s">import sys</span>
<span class="s">import psycopg2</span>
<span class="s">from django.db import connections</span>
<span class="s">try:</span>
<span class="s">    connections[&#39;default&#39;].cursor()</span>
<span class="s">except psycopg2.OperationalError:</span>
<span class="s">    sys.exit(-1)</span>
<span class="s">sys.exit(0)</span>
<span class="s">END</span>
<span class="o">}</span>

<span class="k">until</span> postgres_ready<span class="p">;</span> <span class="k">do</span>
    &gt;<span class="p">&amp;</span><span class="m">2</span> <span class="nb">echo</span> <span class="s2">&quot;==&gt; Waiting for Postgres...&quot;</span>
    sleep <span class="m">1</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;==&gt; Postgres started!&quot;</span>

python manage.py makemigrations users
python manage.py migrate
python manage.py runserver <span class="m">0</span>.0.0.0:8000

<span class="nb">exec</span> <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</pre></div>


<p><strong>Note</strong>: Make sure to <code>chmod +x docker-entrypoint.sh</code>!</p>
<h3>Sanity&nbsp;check</h3>
<p>We can now use docker-compose to build our images and start our development&nbsp;server!</p>
<div class="highlight"><pre><span></span>$ docker-compose up --build
</pre></div>


<p>Visiting <a href="http://0.0.0.0:8000">http://0.0.0.0:8000</a> on your browser should show&#8230; a 404 page. That&#8217;s by design! There&#8217;s no home page yet. Pointing the browser over to <a href="http://0.0.0.0:8000/admin/">http://0.0.0.0:8000/admin/</a> should show a log in screen, which means all is well! You can create a user by opening a new terminal window and using Python inside the running Docker&nbsp;container. </p>
<div class="highlight"><pre><span></span>$ docker-compose <span class="nb">exec</span> web python manage.py createsuperuser
</pre></div>


<p>You may want to start the containers in detached mode so you don&#8217;t have to keep opening terminal&nbsp;windows.</p>
<div class="highlight"><pre><span></span>$ docker-compose up -d
</pre></div>


<h3>Applying a <code>black</code> coat of&nbsp;paint</h3>
<p>After all that, it&#8217;s nice to make sure our code looks nice and consistent. For that, we can use the opinionated Python code formatter,&nbsp;black.</p>
<p>First, create a <code>pyproject.toml</code> file in the root of the project, in order to customize black&#8217;s settings if we so&nbsp;choose.</p>
<div class="highlight"><pre><span></span># vgstack/pyproject.toml

[tool.black]
line-length = 88
</pre></div>


<p>And now,&nbsp;format:</p>
<div class="highlight"><pre><span></span>$ black .
</pre></div>


<p>Looking&nbsp;good.</p>
<h2>Up&nbsp;Next</h2>
<p>Now that the project is set up with best practices thanks to <code>drfx</code> and a nice development workflow using Docker and environment variables, we can get to work writing the actual bulk of the backend. In the next part, we will write the models, serializers, views and (last but not least) the tests that make up our backend&nbsp;code.</p>
<h1>Resources:</h1>
<ul>
<li><a href="https://wsvincent.com/django-docker-postgresql/">https://wsvincent.com/django-docker-postgresql/</a></li>
<li><a href="https://docs.djangoproject.com/en/2.1/ref/settings/">https://docs.djangoproject.com/en/2.1/ref/settings/</a></li>
</ul>
  </div>
</div>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'raulnegron';
        var disqus_title = 'Full-Stack Project: vg-stack (Part&nbsp;1)';
        (function () {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </div>

      <label for="sidebar-checkbox" class="sidebar-toggle"></label>

      <script>
        (function(document) {
          var i = 0;
          // snip empty header rows since markdown can't
          var rows = document.querySelectorAll('tr');
          for(i=0; i<rows.length; i++) {
            var ths = rows[i].querySelectorAll('th');
            var rowlen = rows[i].children.length;
            if (ths.length > 0 && ths.length === rowlen) {
              rows[i].remove();
            }
          }
        })(document);
      </script>

      <script>
        /* Lanyon & Poole are Copyright (c) 2014 Mark Otto. Adapted to Pelican 20141223 and extended a bit by @thomaswilley */
        (function(document) {
          var toggle = document.querySelector('.sidebar-toggle');
          var sidebar = document.querySelector('#sidebar');
          var checkbox = document.querySelector('#sidebar-checkbox');
          document.addEventListener('click', function(e) {
            var target = e.target;
            if(!checkbox.checked ||
            sidebar.contains(target) ||
            (target === checkbox || target === toggle)) return;
            checkbox.checked = false;
            }, false);
            })(document);
      </script>
     </div>
  </body>
</html>