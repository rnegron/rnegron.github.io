<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1"
  />

  <title>
    
    Full-Stack Project: vg-stack (Part 1)
    
  </title>

  
  <script
    type="text/javascript"
    async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"
  >
      MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
           extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i = 0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

        MathJax.Hub.Config({
          
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
  </script>

  
  <link rel="stylesheet" href="/css/poole.css" />
  <link rel="stylesheet" href="/css/syntax.css" />
  <link rel="stylesheet" href="/css/lanyon.css" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400"
  />

  
  <link
    rel="apple-touch-icon-precomposed"
    sizes="144x144"
    href="/assets/apple-touch-icon-144-precomposed.png"
  />
  <link rel="shortcut icon" href="/assets/favicon.ico" />

  
  <link
    rel="alternate"
    type="application/rss+xml"
    title="RSS"
    href="/atom.xml"
  />
</head>


  <body>

    
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <div class="profile">
      <img src="/img/profile.png" />
    </div>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">main page</a>

    
    
      
        <a class="sidebar-nav-item " href="https://raulnegron.me/about/">about me</a>
      
    
      
        <a class="sidebar-nav-item " href="https://raulnegron.me/uses/">uses</a>
      
    
      
        <a class="sidebar-nav-item " href="https://raulnegron.me/blog/">blog</a>
      
    
      
        <a class="sidebar-nav-item " href="https://raulnegron.me/projects/">open source projects</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
<a class="sidebar-nav-item" href="https://github.com/rnegron" target="_blank">github</a>
<a class="sidebar-nav-item" href="https://www.linkedin.com/in/raulnegron/" target="_blank">linkedin</a>
</nav>

<div class="sidebar-item">
  <p>Site written in <a href="https://daringfireball.net/projects/markdown/">Markdown</a>, generated by <a
      href="https://gohugo.io">Hugo</a>, hosted on <a href="https://pages.github.com/">Github
      Pages</a> and registered using <a href="https://aws.amazon.com/route53/">Route 53</a>.</p>
  <p class="tiny-note">
    <a class="muted" href="https://github.com/thomaswilley/pelicanyan">theme: modified hugo-lanyon</a>
  </p>
</div>

<div class="sidebar-item">
  <p>&copy; 2020. All rights reserved.</p>
</div>
</div>


    
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home"></a>
            <small></small>
          </h3>
        </div>
      </div>

      <div class="container content">


<div class="post">
  <h1 class="post-title">Full-Stack Project: vg-stack (Part 1)</h1>
  <span class="post-date">January 19, 2019</span>
  <h1 id="motivation">Motivation</h1>
<p>In the web development space, tools and best-practices change quite frequently. At one point in the not-so-distant past, a <a href="https://en.wikipedia.org/wiki/LAMP_%28software_bundle%29">LAMP</a> stack was the go-to approach for launching a web application. These days, PHP is the #8 most popular programming language (according to a company with the name <a href="https://www.tiobe.com/tiobe-index/">&ldquo;The Importance Of Being Earnest&rdquo;</a>), while Python and JavaScript rank above it.</p>
<p>One of the reason for this change has to do with the growing trend towards microservice architectures. Together with the need for rapid prototyping and the onset of agile development methodologies, Python and other languages have swept in and stolen the LAMP stack&rsquo;s lunch.</p>
<p>So what is the <em>new stack</em>? A complex question with opinionated answers&hellip; Here is a recent community discussion on Hacker News: <a href="https://news.ycombinator.com/item?id=18829557">Go-to web stack today?</a></p>
<p>But wow, there are so many things to learn and keep up to date with nowadays! To help alleviate this, I&rsquo;d like to work on a side-project using full-stack technologies. In particular, I want to use the following tools to build a fullstack app:</p>
<ul>
<li>Django (backend)</li>
<li>Ember (frontend)</li>
<li>Docker (development/deployment)</li>
<li>Postgres (database)</li>
<li>&hellip; plus many more! (think git, pipenv, serverless, test-driven development&hellip; Maybe type-hints, GraphQL and data visualization too?)</li>
</ul>
<h1 id="the-idea-a-web-app-for-keeping-track-of-your-video-game-backlog">The idea: A web app for keeping track of your video game backlog</h1>
<p>No shame: the project is most definitely a copy of <a href="https://backloggery.com">The Backloggery</a>, a great site that I use often. However, as far as I know, The Backloggery is <a href="https://backloggery.com/about.php">built in PHP</a>, probably on a LAMP stack or similar. So I thought I would take a crack at building a small subset of the Backloggery features, on a more modern stack.</p>
<p>I like this idea because it comes with a well-defined problem set. I can already envision the database schema and how to build the backend. But as I mentioned, this project is going to involve the entire stack. That means I gotta learn some frontend JavaScript. In this series of blog posts, I document my experience.</p>
<blockquote>
<p>I should say, the reason I picked <a href="https://emberjs.com/">Ember</a> and not (the elephant in the room) <a href="https://reactjs.org/">React</a> is that in my <a href="https://www.aliaspayments.com">day job</a>, we work with Ember and so this is a skill I would like to improve! Besides, we all know <a href="https://en.wikipedia.org/wiki/PostgreSQL">Postgres</a> is the real elephant here, right? Let&rsquo;s move on.</p>
</blockquote>
<h1 id="the-app-vg-stack">The app: vg-stack</h1>
<p>I had to name my repo something!</p>
<p>In all honestly, I like the name because it hints at the purpose of the project (practicing the web stack) while at the same conjuring a mental image of a bunch of video games stacked on top of each other.</p>
<h2 id="setting-up">Setting up</h2>
<p>For this first part, I&rsquo;m going to build a backend skeleton using Django and the awesome <a href="https://www.django-rest-framework.org/">Django REST framework</a> package. As already mentioned, our database will be the ever-popular PostgreSQL and we are aiming for best practices in all parts of the stack. That includes deployment/development tools and environments! That said, I&rsquo;m going to assume knowledge of the tools used and explain only the highlights.</p>
<h2 id="project-structure">Project Structure</h2>
<p>In fact, I&rsquo;m going to skip most of the project setup entirely and just go with a pre-built template! I like William Vincent&rsquo;s <a href="https://github.com/wsvincent/drfx">drfx</a>, so let&rsquo;s go ahead and clone that:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ git clone https://github.com/wsvincent/drfx vgstack
</code></pre></div><p>The template provided comes with a lot of best practices built in. We can build on top of it and get going quickly!</p>
<h3 id="dependencies">Dependencies</h3>
<p>We&rsquo;re going to install the following extra packages for now:
<a href="https://github.com/theskumar/python-dotenv">python-dotenv</a> to comply with <a href="https://12factor.net/config">mandate III</a> of The Twelve-Factor App, <a href="https://github.com/psycopg/psycopg2">psycopg2-binary</a> to use PostgreSQL as our database, <a href="https://github.com/ambv/black">black</a> to format our code and <a href="https://github.com/FactoryBoy/factory_boy">factory_boy</a> to improve our tests maintenance.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ pipenv install python-dotenv psycopg2-binary
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ pipenv install --pre --dev black factory_boy
</code></pre></div><p>We install <code>black</code> and <code>factory_boy</code> as development dependencies and tell Pipenv to allow the pre-release <code>black</code> package through!</p>
<h2 id="django-settings">Django Settings</h2>
<p>Let&rsquo;s get started setting up our project.</p>
<p>First, create a <code>.env</code> file for use with <code>python-dotenv</code>.</p>
<pre><code class="language-env" data-lang="env"># vgstack/.env

DEBUG=on
SECRET_KEY=your-secret-key
DATABASE_USER=postgres
DATABASE_PASSWORD=postgres
DATABASE_NAME=postgres
DATABASE_HOST=database
DATABASE_PORT=5432
</code></pre><p>Replace the <code>SECRET_KEY</code> with an actual secret key! You can generate one in Python:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.core.management.utils</span> <span class="kn">import</span> <span class="n">get_random_secret_key</span>

<span class="n">get_random_secret_key</span><span class="p">()</span>
</code></pre></div><p>The database env variables can stay as they are, since those settings happily coincide with the default database, user and password in the <a href="https://hub.docker.com/_/postgres">Postgres Docker Image</a>!</p>
<p>Now, replace &ldquo;drfx&rdquo; with &ldquo;vgstack&rdquo; everywhere it appears in the project, such as in values for <code>ROOT_URLCONF</code>, <code>WSGI_APPLICATION</code> and even the main &ldquo;drfx&rdquo; directory!</p>
<p>We also modify our settings file in order to use <code>python-dotenv</code>. In the end, it should look like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># vgstack/vgstack/settings.py</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>


<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
<span class="n">dotenv_path</span> <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s1">&#39;.env&#39;</span>
<span class="n">load_dotenv</span><span class="p">(</span><span class="n">dotenv_path</span><span class="o">=</span><span class="n">dotenv_path</span><span class="p">)</span>


<span class="c1"># SECURITY WARNING: don&#39;t run with debug turned on in production!</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;DEBUG&#34;</span><span class="p">)</span>

<span class="c1"># SECURITY WARNING: keep the secret key used in production secret!</span>
<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;SECRET_KEY&#34;</span><span class="p">)</span>

<span class="c1"># Allow communicaiton from our Docker container if DEBUG=True</span>
<span class="n">ALLOWED_HOSTS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;0.0.0.0&#34;</span><span class="p">]</span> <span class="k">if</span> <span class="n">DEBUG</span> <span class="k">else</span> <span class="p">[]</span>

<span class="c1"># ...</span>

<span class="n">ROOT_URLCONF</span> <span class="o">=</span> <span class="s2">&#34;vgstack.urls&#34;</span>

<span class="c1"># ...</span>

<span class="n">WSGI_APPLICATION</span> <span class="o">=</span> <span class="s2">&#34;vgstack.wsgi.application&#34;</span>

<span class="c1"># Database</span>
<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&#34;default&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&#34;ENGINE&#34;</span><span class="p">:</span> <span class="s2">&#34;django.db.backends.postgresql&#34;</span><span class="p">,</span>
    <span class="s2">&#34;NAME&#34;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;DATABASE_NAME&#34;</span><span class="p">),</span>
    <span class="s2">&#34;USER&#34;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;DATABASE_USER&#34;</span><span class="p">),</span>
    <span class="s2">&#34;PASSWORD&#34;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;DATABASE_PASSWORD&#34;</span><span class="p">),</span>
    <span class="s2">&#34;HOST&#34;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;DATABASE_HOST&#34;</span><span class="p">),</span>
    <span class="s2">&#34;PORT&#34;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;DATABASE_PORT&#34;</span><span class="p">),</span>
    <span class="s2">&#34;CONN_MAX_AGE&#34;</span><span class="p">:</span> <span class="mi">7200</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># ...</span>
</code></pre></div><p>Notice I replaced the <code>os.path</code> call for the new kid on the block: <code>Pathlib</code>. I&rsquo;m trying to make that a habit!</p>
<h3 id="docker">Docker</h3>
<p>Let&rsquo;s build a simple Python Dockerfile!</p>
<div class="highlight"><pre class="chroma"><code class="language-docker" data-lang="docker"><span class="c"># vgstack/Dockerfile</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># pull the Python official base image, slimmed down</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> python:3.7-slim</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># set environment varibles</span><span class="err">
</span><span class="err"></span><span class="k">ENV</span> PYTHONDONTWRITEBYTECODE <span class="m">1</span><span class="err">
</span><span class="err"></span><span class="k">ENV</span> PYTHONUNBUFFERED <span class="m">1</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># set work directory</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /usr/src/app</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># install dependencies with Pipenv</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> pip install --upgrade pip <span class="o">&amp;&amp;</span> pip install pipenv<span class="err">
</span><span class="err"></span><span class="k">COPY</span> ./Pipfile /usr/src/app/Pipfile<span class="err">
</span><span class="err"></span><span class="k">RUN</span> pipenv install --system --skip-lock<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># copy project over to image</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> . /usr/src/app/<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># specify our entrypoint</span><span class="err">
</span><span class="err"></span><span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&#34;./docker-entrypoint.sh&#34;</span><span class="p">]</span><span class="err">
</span></code></pre></div><p>And a nice docker-compose file to help us run the project and related services.</p>
<div class="highlight"><pre class="chroma"><code class="language-docker" data-lang="docker"><span class="c"># vgstack/docker-compose.yml</span><span class="err">
</span><span class="err">
</span><span class="err"></span>version: <span class="s1">&#39;3.7&#39;</span><span class="err">
</span><span class="err">
</span><span class="err"></span>services:<span class="err">
</span><span class="err"></span>  database:<span class="err">
</span><span class="err"></span>    image: postgres:11-alpine<span class="err">
</span><span class="err"></span>    volumes:<span class="err">
</span><span class="err"></span>      - postgres_data:/var/lib/postgresql/data/<span class="err">
</span><span class="err">
</span><span class="err"></span>  web:<span class="err">
</span><span class="err"></span>    build: .<span class="err">
</span><span class="err"></span>    entrypoint: /usr/src/app/docker-entrypoint.sh<span class="err">
</span><span class="err"></span>    volumes:<span class="err">
</span><span class="err"></span>      - ./:/usr/src/app/<span class="err">
</span><span class="err"></span>    ports:<span class="err">
</span><span class="err"></span>      - 8000:8000<span class="err">
</span><span class="err"></span>    env_file: .env<span class="err">
</span><span class="err"></span>    depends_on:<span class="err">
</span><span class="err"></span>      - database<span class="err">
</span><span class="err"></span>volumes:<span class="err">
</span><span class="err"></span>  postgres_data:<span class="err">
</span><span class="err"></span>    external: false<span class="err">
</span></code></pre></div><p>We can see that we are persisting the Postgres database via Docker volumes. Also, we are taking advantage of the <code>env_file</code> command to load in our previously created file. Finally, we call the <code>entrypoint</code> command to run a shell script instead of running an in-line command.</p>
<p>The following entrypoint script is a modified version of the one found in Jos√© Padilla&rsquo;s <a href="https://github.com/jpadilla/notaso">notaso</a> project. It attempts to use a PostgreSQL cursor every second, and keeps trying until a connection succeeds. Then, it proceeds to migrate the Django models and runs the development server.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="cp">#!/bin/sh
</span><span class="cp"></span>
<span class="c1"># vgstack/docker-entrypoint.sh</span>

<span class="nb">set</span> -e

postgres_ready<span class="o">(){</span>
python manage.py shell <span class="s">&lt;&lt; END
</span><span class="s">import sys
</span><span class="s">import psycopg2
</span><span class="s">from django.db import connections
</span><span class="s">try:
</span><span class="s">    connections[&#39;default&#39;].cursor()
</span><span class="s">except psycopg2.OperationalError:
</span><span class="s">    sys.exit(-1)
</span><span class="s">sys.exit(0)
</span><span class="s">END</span>
<span class="o">}</span>

<span class="k">until</span> postgres_ready<span class="p">;</span> <span class="k">do</span>
    &gt;<span class="p">&amp;</span><span class="m">2</span> <span class="nb">echo</span> <span class="s2">&#34;==&gt; Waiting for Postgres...&#34;</span>
    sleep <span class="m">1</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&#34;==&gt; Postgres started!&#34;</span>

python manage.py makemigrations users
python manage.py migrate
python manage.py runserver 0.0.0.0:8000

<span class="nb">exec</span> <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
</code></pre></div><p><strong>Note</strong>: Make sure to <code>chmod +x docker-entrypoint.sh</code>!</p>
<h3 id="sanity-check">Sanity check</h3>
<p>We can now use docker-compose to build our images and start our development server!</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ docker-compose up --build
</code></pre></div><p>Visiting <a href="http://0.0.0.0:8000">http://0.0.0.0:8000</a> on your browser should show&hellip; a 404 page. That&rsquo;s by design! There&rsquo;s no home page yet. Pointing the browser over to <a href="http://0.0.0.0:8000/admin/">http://0.0.0.0:8000/admin/</a> should show a log in screen, which means all is well! You can create a user by opening a new terminal window and using Python inside the running Docker container.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ docker-compose <span class="nb">exec</span> web python manage.py createsuperuser
</code></pre></div><p>You may want to start the containers in detached mode so you don&rsquo;t have to keep opening terminal windows.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ docker-compose up -d
</code></pre></div><h3 id="applying-a-black-coat-of-paint">Applying a <code>black</code> coat of paint</h3>
<p>After all that, it&rsquo;s nice to make sure our code looks nice and consistent. For that, we can use the opinionated Python code formatter, black.</p>
<p>First, create a <code>pyproject.toml</code> file in the root of the project, in order to customize black&rsquo;s settings if we so choose.</p>
<pre><code># vgstack/pyproject.toml

[tool.black]
line-length = 88
</code></pre><p>And now, format:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ black .
</code></pre></div><p>Looking good.</p>
<h2 id="up-next">Up Next</h2>
<p>Now that the project is set up with best practices thanks to <code>drfx</code> and we have a nice development workflow using Docker, we can get to work writing the actual bulk of the backend. In the next part, we will write the models, serializers, views and (last but not least) the tests that make up our backend code.</p>
<h1 id="resources">Resources</h1>
<ul>
<li><a href="https://wsvincent.com/django-docker-postgresql/">https://wsvincent.com/django-docker-postgresql/</a></li>
<li><a href="https://docs.djangoproject.com/en/2.1/ref/settings/">https://docs.djangoproject.com/en/2.1/ref/settings/</a></li>
</ul>
<h1 id="update-2019-03-14">Update (2019-03-14)</h1>
<p>A previous version of this post mentioned using Angular for the frontend, as this was what my team was using at the time. I&rsquo;ve since switched jobs, and I want to focus on using my current team&rsquo;s frontend tech!</p>

</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>

